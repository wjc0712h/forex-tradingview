//WOOJIN CHOI, 9/29/2025
//@version=6
bool hideCurrentWeek = true
bool showCommercials = true
bool showLarge = true
color_eur = color(color.blue)
color_usd = color(#0000ff)
color_gbp = color(color.purple)
color_chf = color(color.fuchsia)
color_jpy = color(color.orange)
color_aud = color(color.lime)
color_cad = color(color.red)
color_nzd = color(color.green)

indicator("COT Report", shorttitle="COT", precision=0)

import TradingView/LibraryCOT/2 as cot

var string Root_Symbol = syminfo.root

isForex = syminfo.type == "forex"
var string CFTC_Code_base = isForex ? cot.convertRootToCOTCode("Base currency") : cot.convertRootToCOTCode("Auto") 
var string CFTC_Code_quote =  isForex ? cot.convertRootToCOTCode("Currency")  : cot.convertRootToCOTCode("Auto")

string option = input.string("Financial", options = ["Legacy", "Financial"], title="Trader Category")
string code_option = input.string("Default", options = [ "Default","Base", "Quote"], title="Trader Category")
// string legacy_option    = input.string("Noncommercial Positions", options = ["Noncommercial Positions", "Commercial Positions"], title="Legacy")
// string financial_option = input.string("Leveraged Funds Positions", options = ["Leveraged Funds Positions", "Dealer Positions", "Asset Manager Positions"], title="Financial")
CFTC_Code_fixed = code_option == "Base" ? CFTC_Code_base : code_option == "Quote" ?CFTC_Code_quote : cot.convertRootToCOTCode("Auto")

dataRequest(code, metricName, direction) =>
    tickerId = cot.COTTickerid(option, code, false, metricName, direction, "All")
    value = request.security(tickerId, "1D", close, ignore_invalid_symbol = true)
    if barstate.islastconfirmedhistory and na(value)
        runtime.error("Could not find relevant COT data based on the current symbol.")
    value

// Calculates net long positions for commercials
net(code, option) =>
    long = dataRequest(code, option, "Long") 
    short = dataRequest(code, option, "Short")
    long - short
//
// eur_lev = hideCurrentWeek ? (timenow >= time_close ?  net("099741","Leveraged Funds Positions") : na) : na
// usd_lev = hideCurrentWeek ? (timenow >= time_close ?  net("098662","Leveraged Funds Positions") : na) : na
// gbp_lev = hideCurrentWeek ? (timenow >= time_close ?  net("096742","Leveraged Funds Positions") : na) : na
// chf_lev = hideCurrentWeek ? (timenow >= time_close ?  net("092741","Leveraged Funds Positions") : na) : na
// jpy_lev = hideCurrentWeek ? (timenow >= time_close ?  net("097741","Leveraged Funds Positions") : na) : na
// aud_lev = hideCurrentWeek ? (timenow >= time_close ?  net("232741","Leveraged Funds Positions") : na) : na
// cad_lev = hideCurrentWeek ? (timenow >= time_close ?  net("090741","Leveraged Funds Positions") : na) : na
// nzd_lev = hideCurrentWeek ? (timenow >= time_close ?  net("112741","Leveraged Funds Positions") : na) : na

// eur_deal = hideCurrentWeek ? (timenow >= time_close ? net("099741","Dealer Positions") : na) : na
// usd_deal = hideCurrentWeek ? (timenow >= time_close ? net("098662","Dealer Positions") : na) : na
// gbp_deal = hideCurrentWeek ? (timenow >= time_close ? net("096742","Dealer Positions") : na) : na
// chf_deal = hideCurrentWeek ? (timenow >= time_close ? net("092741","Dealer Positions") : na) : na
// jpy_deal = hideCurrentWeek ? (timenow >= time_close ? net("097741","Dealer Positions") : na) : na
// aud_deal = hideCurrentWeek ? (timenow >= time_close ? net("232741","Dealer Positions") : na) : na
// cad_deal = hideCurrentWeek ? (timenow >= time_close ? net("090741","Dealer Positions") : na) : na
// nzd_deal = hideCurrentWeek ? (timenow >= time_close ? net("112741","Dealer Positions") : na) : na

// eur_ass = hideCurrentWeek ? (timenow >= time_close ?  net("099741","Asset Manager Positions") : na) : na
// usd_ass = hideCurrentWeek ? (timenow >= time_close ?  net("098662","Asset Manager Positions") : na) : na
// gbp_ass = hideCurrentWeek ? (timenow >= time_close ?  net("096742","Asset Manager Positions") : na) : na
// chf_ass = hideCurrentWeek ? (timenow >= time_close ?  net("092741","Asset Manager Positions") : na) : na
// jpy_ass = hideCurrentWeek ? (timenow >= time_close ?  net("097741","Asset Manager Positions") : na) : na
// aud_ass = hideCurrentWeek ? (timenow >= time_close ?  net("232741","Asset Manager Positions") : na) : na
// cad_ass = hideCurrentWeek ? (timenow >= time_close ?  net("090741","Asset Manager Positions") : na) : na
// nzd_ass = hideCurrentWeek ? (timenow >= time_close ?  net("112741","Asset Manager Positions") : na) : na

base_lev = hideCurrentWeek and option == "Financial" ? (timenow >= time_close ?  net(CFTC_Code_fixed,"Leveraged Funds Positions") : na) : na
base_deal = hideCurrentWeek and option == "Financial"? (timenow >= time_close ?  net(CFTC_Code_fixed,"Dealer Positions") : na) : na
base_ass = hideCurrentWeek  and option == "Financial"? (timenow >= time_close ?  net(CFTC_Code_fixed,"Asset Manager Positions") : na) : na

base_comm = hideCurrentWeek and option == "Legacy" ? (timenow >= time_close ?  net(CFTC_Code_fixed,"Commercial Positions") : na) : na
base_noncomm = hideCurrentWeek and option == "Legacy"? (timenow >= time_close ?  net(CFTC_Code_fixed,"Noncommercial Positions") : na) : na


// show_eur = str.contains(upperSymbol, "EUR")
// show_usd = str.contains(upperSymbol, "USD")
// show_gbp = str.contains(upperSymbol, "GBP")
// show_chf = str.contains(upperSymbol, "CHF")
// show_jpy = str.contains(upperSymbol, "JPY")
// show_aud = str.contains(upperSymbol, "AUD")
// show_cad = str.contains(upperSymbol, "CAD")
// show_nzd = str.contains(upperSymbol, "NZD")

color_ass = (base_ass) >(base_ass[1]) ? color.orange : color.rgb(255, 167, 4)
color_lev = (base_lev) >(base_lev[1]) ? color.red : color.rgb(255, 0, 0)
color_deal = (base_deal) >(base_deal[1]) ? color.blue : color.rgb(0, 60, 255)

color_comm = (base_comm) >(base_comm[1]) ? color.blue : color.rgb(0, 60, 255)
color_noncomm = (base_noncomm) >(base_noncomm[1]) ? color.red : color.rgb(255, 0, 0)

plot(base_lev, title="base lev", color=color_lev, linewidth=1)
plot(base_ass, title="base asset", color=color_ass, linewidth=1)
plot(base_deal, title="base deal", color=color_deal, linewidth=1)

plot(base_noncomm, title="base non comm", color=color_comm, linewidth=1)
plot(base_comm, title="base comm", color=color_noncomm, linewidth=1)
hline(0.0,color = color.black)

// Calculate differences - check for na values first
diff_lev_ass = na(base_lev[1]) or na(base_ass[1]) or na(base_lev[2]) or na(base_ass[2]) ? na : (base_lev[1] + base_ass[1]) - (base_lev[2] + base_ass[2])

diff_deal = na(base_deal[1]) or na(base_deal[2]) ? na : base_deal[1] - base_deal[2]

comm_diff = na(base_comm[1]) or na(base_comm[2]) ? na : base_comm[1] - base_comm[2]

noncomm_diff = na(base_noncomm[1]) or na(base_noncomm[2]) ? na : base_noncomm[1] - base_noncomm[2]

codeToCurrency(string code) =>
    string currency = switch code
        "133741" => "BTC"
        "098662" => "USD"
        "099741" => "EUR"
        "097741" => "JPY"
        "095741" => "MXN"
        "092741" => "CHF"
        "089741" => "RUB"
        "090741" => "CAD"
        "112741" => "NZD"
        "096742" => "GBP"
        "102741" => "BRL"
        "122741" => "ZAR"
        "232741" => "AUD"
        "146021" => "ETH"
        => code
    currency

var table symbolDisplay = table.new(position.bottom_right, 3, 4)

diff_1 = option == "Financial" ? diff_lev_ass : noncomm_diff
diff_2 = option == "Financial" ? diff_deal : comm_diff


// Enhanced table with debugging info
if barstate.islast
    color TEXT_COLOR = color.white
    color BG_COLOR = color.new(color.black, 50)
    color WARN_COLOR = color.new(color.orange, 30)
    

    string currency = codeToCurrency(CFTC_Code_fixed)
    string header = str.format("{0}/{1}", currency, option)
    
    // Header
    table.cell(symbolDisplay, 0, 0, header, text_halign=text.align_center, text_color=TEXT_COLOR, bgcolor=BG_COLOR)
    table.cell(symbolDisplay, 2, 0, "Diff", text_halign=text.align_center, text_color=TEXT_COLOR, bgcolor=BG_COLOR)
    
    // Data availability check
    current_main = option == "Financial" ? base_lev + base_ass : base_noncomm
    current_secondary = option == "Financial" ? base_deal : base_comm
    
    // Row 1: Main category
    string main_label = option == "Financial" ? "Lev+Asset" : "Non-Comm"
    string diff_main_str = na(diff_1) ? "No Data" : str.tostring(diff_1, "#")
    
    color_main = math.abs(base_lev+base_ass) > math.abs((base_lev[1] + base_ass[1])) ? color.red : TEXT_COLOR
    color_second = math.abs(base_deal) > math.abs(base_deal[1]) ? color.blue : TEXT_COLOR
    table.cell(symbolDisplay, 0, 1, main_label, text_halign=text.align_left, text_color=TEXT_COLOR, bgcolor=BG_COLOR)
    table.cell(symbolDisplay, 2, 1, diff_main_str, text_halign=text.align_right, text_color=color_main, bgcolor=na(diff_1) ? WARN_COLOR : BG_COLOR)
    
    // Row 2: Secondary category
    string secondary_label = option == "Financial" ? "Dealer" : "Comm"
    string diff_secondary_str = na(diff_2) ? "No Data" : str.tostring(diff_2, "#")
    
    table.cell(symbolDisplay, 0, 2, secondary_label, text_halign=text.align_left, text_color=TEXT_COLOR, bgcolor=BG_COLOR)
    table.cell(symbolDisplay, 2, 2, diff_secondary_str, text_halign=text.align_right, text_color=color_second, bgcolor=na(diff_2) ? WARN_COLOR : BG_COLOR)
    
    // Debug row: Show CFTC code
    table.cell(symbolDisplay, 0, 3, "CFTC Code", text_halign=text.align_left, text_color=TEXT_COLOR, bgcolor=BG_COLOR, text_size=size.tiny)
    table.cell(symbolDisplay, 2, 3, CFTC_Code_base, text_halign=text.align_right, text_color=TEXT_COLOR, bgcolor=BG_COLOR, text_size=size.tiny)